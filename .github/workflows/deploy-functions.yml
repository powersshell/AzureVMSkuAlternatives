name: Deploy Flex Consumption Functions

on:
  push:
    branches:
      - main
    paths:
      - 'web-app/api/**'
      - 'web-app/infra/functions-app-flex.bicep'
      - '.github/workflows/deploy-functions.yml'
  workflow_dispatch:
    inputs:
      deploy_infrastructure:
        description: 'Deploy infrastructure (Bicep)'
        required: false
        type: boolean
        default: false

env:
  AZURE_FUNCTIONAPP_NAME: 'vmsku-api-functions-flex'
  AZURE_FUNCTIONAPP_PACKAGE_PATH: 'web-app/api'
  PYTHON_VERSION: '3.11'
  RESOURCE_GROUP: 'rg-vmsku-alternatives'

# Required permissions for OIDC authentication
permissions:
  id-token: write  # Required for requesting the JWT
  contents: read   # Required for actions/checkout

jobs:
  # Optional infrastructure deployment job
  deploy-infrastructure:
    runs-on: ubuntu-latest
    # Only run if manually triggered with deploy_infrastructure=true
    if: github.event.inputs.deploy_infrastructure == 'true'
    steps:
      - name: 'Checkout code'
        uses: actions/checkout@v4

      - name: 'Azure Login via OIDC'
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: 'Deploy Bicep template'
        id: bicep-deploy
        uses: azure/arm-deploy@v1
        with:
          resourceGroupName: ${{ env.RESOURCE_GROUP }}
          template: ./web-app/infra/functions-app-flex.bicep
          parameters: functionsAppName=${{ env.AZURE_FUNCTIONAPP_NAME }}
          failOnStdErr: false

      - name: 'Assign Reader role at subscription level'
        run: |
          echo "üîë Assigning Reader role to Function App managed identity..."
          
          # Get the Function App's managed identity principal ID
          PRINCIPAL_ID=$(az functionapp identity show \
            --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query principalId -o tsv)
          
          echo "Principal ID: $PRINCIPAL_ID"
          
          # Assign Reader role at subscription level
          az role assignment create \
            --role "Reader" \
            --assignee-object-id "$PRINCIPAL_ID" \
            --assignee-principal-type ServicePrincipal \
            --scope "/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}" \
            --output none || echo "‚ö†Ô∏è  Reader role may already exist"
          
          echo "‚úÖ Reader role assigned (or already exists)"

      - name: 'Wait for RBAC propagation'
        run: |
          echo "‚è≥ Waiting 120 seconds for RBAC roles to propagate..."
          sleep 120

  # Function code deployment job
  build-and-deploy:
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure]
    # Run if infrastructure job completed or was skipped
    if: always() && (needs.deploy-infrastructure.result == 'success' || needs.deploy-infrastructure.result == 'skipped')
    steps:
      - name: 'Checkout code'
        uses: actions/checkout@v4

      - name: 'Setup Python ${{ env.PYTHON_VERSION }}'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: 'Resolve Project Dependencies'
        shell: bash
        run: |
          pushd './${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}'
          python -m pip install --upgrade pip
          pip install -r requirements.txt --target=".python_packages/lib/site-packages"
          popd

      - name: 'Azure Login via OIDC'
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: 'Create deployment package'
        shell: bash
        run: |
          echo "üì¶ Creating deployment package..."
          cd '${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}'
          zip -r ../function-app.zip . -x "*.git*"
          cd ..
          ls -lh function-app.zip
          
      - name: 'Deploy to Azure Functions (Flex Consumption)'
        shell: bash
        run: |
          echo "üöÄ Deploying to Flex Consumption Function App..."
          echo "   Function App: ${{ env.AZURE_FUNCTIONAPP_NAME }}"
          echo "   Resource Group: ${{ env.RESOURCE_GROUP }}"
          
          # Deploy using Azure CLI (works with private storage and managed identity)
          az functionapp deployment source config-zip \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
            --src function-app.zip \
            --build-remote true \
            --verbose
          
          echo "‚úÖ Deployment command completed"

      - name: 'Wait for deployment to complete'
        run: |
          echo "‚è≥ Waiting 30 seconds for Function App to initialize..."
          sleep 30

      - name: 'Test Health Endpoint'
        run: |
          echo "üß™ Testing health endpoint..."
          HEALTH_URL="https://${{ env.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net/api/health"
          
          for i in {1..5}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || echo "000")
            
            if [ "$HTTP_CODE" == "200" ]; then
              echo "‚úÖ Health endpoint is responding (HTTP $HTTP_CODE)"
              curl -s "$HEALTH_URL" | jq '.'
              exit 0
            else
              echo "‚è≥ Attempt $i: HTTP $HTTP_CODE (waiting 10 seconds...)"
              sleep 10
            fi
          done
          
          echo "‚ö†Ô∏è Health endpoint not responding after 5 attempts"
          echo "This is not necessarily an error - the Function App may still be starting up"
          exit 0

  # Verification job
  verify-deployment:
    runs-on: ubuntu-latest
    needs: [build-and-deploy]
    steps:
      - name: 'Azure Login via OIDC'
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: 'Verify Function App Configuration'
        run: |
          echo "üîç Verifying Function App configuration..."
          
          # Check Function App exists and is running
          az functionapp show \
            --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "{Name:name,State:state,Runtime:siteConfig.linuxFxVersion,Kind:kind}" \
            -o table
          
          # List deployed functions
          echo ""
          echo "üìã Deployed functions:"
          az functionapp function list \
            --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "[].{Name:name}" \
            -o table || echo "Could not list functions (this is OK if deployment just completed)"
          
          # Check VNet integration
          echo ""
          echo "üåê VNet Integration:"
          az functionapp vnet-integration list \
            --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "[].{SubnetId:id}" \
            -o table || echo "VNet integration not configured or not accessible"

      - name: 'Security Check: Verify Private Storage'
        run: |
          echo "üîí Verifying storage security configuration..."
          
          # Get storage account name from Function App settings
          STORAGE_NAME=$(az functionapp config appsettings list \
            --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "[?name=='AzureWebJobsStorage__accountName'].value" \
            -o tsv)
          
          if [ -n "$STORAGE_NAME" ]; then
            echo "Storage Account: $STORAGE_NAME"
            
            # Check public access and key access settings
            az storage account show \
              --name "$STORAGE_NAME" \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --query "{Name:name,PublicAccess:publicNetworkAccess,KeyAccess:allowSharedKeyAccess}" \
              -o table
            
            # Verify private endpoints exist
            echo ""
            echo "Private Endpoints:"
            az network private-endpoint list \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --query "[?contains(name, '$STORAGE_NAME')].{Name:name,ProvisioningState:provisioningState}" \
              -o table
          else
            echo "‚ö†Ô∏è Could not determine storage account name"
          fi

      - name: 'Deployment Summary'
        run: |
          echo ""
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "‚úÖ DEPLOYMENT COMPLETE"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo ""
          echo "Function App: ${{ env.AZURE_FUNCTIONAPP_NAME }}"
          echo "Resource Group: ${{ env.RESOURCE_GROUP }}"
          echo ""
          echo "Endpoints:"
          echo "  Health: https://${{ env.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net/api/health"
          echo "  Compare: https://${{ env.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net/api/compare_vms"
          echo ""
          echo "Authentication: OIDC (No secrets used) ‚úÖ"
          echo "Storage: Private endpoints only ‚úÖ"
          echo "Keys: Disabled ‚úÖ"
          echo ""

